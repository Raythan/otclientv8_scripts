local followWindow = nil
local followButton = nil
local targetNameInput = nil
local stopButton = nil
local followEvent = nil
local targetName = nil

function followTarget()
    if not targetName or not g_game.isOnline() then
        stopFollow()
        return
    end

    local creature = g_game.getCreatureByName(targetName)
    if creature then
        if g_game.getFollowingCreature() ~= creature then
            g_game.follow(creature)
        end
    else
        g_game.cancelFollow()
    end
end

function startFollow(name)
    if followEvent then
        stopFollow()
    end
    targetName = name
    if targetName and #targetName > 0 then
        followEvent = cycleEvent(followTarget, 500)
        g_game.talk("Following: " .. targetName)
        followTarget()
    end
end

function stopFollow()
    if followEvent then
        removeEvent(followEvent)
        followEvent = nil
        g_game.cancelFollow()
        if targetName then
            g_game.talk("Stopped following: " .. targetName)
            targetName = nil
        end
    end
end

function toggle()
    if followWindow and followWindow:isVisible() then
        followWindow:hide()
    else
        init()
        followWindow:show()
        followWindow:raise()
        followWindow:focus()
    end
end

function init()
    if followWindow then
        return
    end

    followWindow = g_ui.createWidget('UIWindow')
    followWindow:setText('Follow Player')
    followWindow:setSize(200, 100)
    followWindow:setAnchorHorizontalCenter('parent.horizontalCenter')
    followWindow:setAnchorVerticalCenter('parent.verticalCenter')
    followWindow.onClose = toggle

    targetNameInput = g_ui.createWidget('UITextEdit', followWindow)
    targetNameInput:setAnchorTop('parent.top')
    targetNameInput:setAnchorLeft('parent.left')
    targetNameInput:setAnchorRight('parent.right')
    targetNameInput:setMarginTop(5)
    targetNameInput:setMarginLeft(5)
    targetNameInput:setMarginRight(5)

    followButton = g_ui.createWidget('UIButton', followWindow)
    followButton:setText('Follow')
    followButton:setAnchorLeft('parent.left')
    followButton:setAnchorBottom('parent.bottom')
    followButton:setMarginLeft(5)
    followButton:setMarginBottom(5)
    followButton:setWidth(90)
    followButton.onClick = function()
        startFollow(targetNameInput:getText())
    end

    stopButton = g_ui.createWidget('UIButton', followWindow)
    stopButton:setText('Stop')
    stopButton:setAnchorRight('parent.right')
    stopButton:setAnchorBottom('parent.bottom')
    stopButton:setMarginRight(5)
    stopButton:setMarginBottom(5)
    stopButton:setWidth(90)
    stopButton.onClick = function()
        stopFollow()
    end

    followWindow:hide() -- Hide window initially, toggle will show it
end

function terminate()
    if followWindow then
        followWindow:destroy()
        followWindow = nil
    end
    if openFollowWindowButton then
        openFollowWindowButton:destroy()
        openFollowWindowButton = nil
    end
    stopFollow()
end

-- Create a button to open the follow window
openFollowWindowButton = g_ui.createWidget('UIButton', g_ui.getRootWidget())
openFollowWindowButton:setText('Follow')
openFollowWindowButton:setAnchorTop('parent.top')
openFollowWindowButton:setAnchorRight('parent.right')
openFollowWindowButton:setMarginTop(10)
openFollowWindowButton:setMarginRight(100)
openFollowWindowButton.onClick = toggle

-- Call init to create the window structure but keep it hidden
init()

-- Cleanup when script is unloaded
g_game.onGameEnd(function()
  terminate()
end)