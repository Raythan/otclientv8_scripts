local targetName = nil
local followEvent = nil

function followTarget()
    if not targetName or not g_game.isOnline() then
        stopFollow()
        return
    end

    local creature = g_game.getCreatureByName(targetName)
    if creature then
        if g_game.getFollowingCreature() ~= creature then
            g_game.follow(creature)
        end
    else
        g_game.cancelFollow()
    end
end

function startFollow(name)
    if followEvent then
        stopFollow()
    end
    targetName = name
    followEvent = cycleEvent(followTarget, 500)
    g_game.talk("Following: " .. targetName)
    followTarget()
end

function stopFollow()
    if followEvent then
        removeEvent(followEvent)
        followEvent = nil
        g_game.cancelFollow()
        if targetName then
            g_game.talk("Stopped following: " .. targetName)
            targetName = nil
        end
    end
end

function onTextMessage(mode, text)
    if text:sub(1, 8) == "/follow " then
        local name = text:sub(9)
        if name and #name > 0 then
            startFollow(name)
        end
        return false
    elseif text == "/follow" then
        stopFollow()
        return false
    end
    return true
end

connect(g_game, {
    onGameEnd = stopFollow,
    onTextMessage = onTextMessage
})