--[[
  SCRIPT FINAL COM SISTEMA DE DETECÇÃO DE ERROS (TRY-CATCH)
]]

-- Interface
UI.Label("Auto Follow")
addTextEdit("followleader", storage.followLeader or "player name", function(widget, text)
  storage.followLeader = text
end)

-- Variáveis de controle
local toFollowPos = {}
local stairToUse = nil
local followMacro = nil -- Apenas declaramos a variável aqui

-- Função para mostrar o erro e desativar o script
function handleError(errorTitle, errorMessage)
  -- Se o macro existir e estiver ativo, desliga ele
  if followMacro and followMacro.isOn and followMacro:isOn() then
    followMacro:off()
    -- Se houver um checkbox, pode ser necessário desmarcá-lo manualmente aqui
    -- Ex: followCheckbox:setChecked(false)
  end
  -- Mostra a caixa de alerta para o usuário
  UI.alert(errorTitle, "O script foi desativado automaticamente.\n\nPor favor, copie o erro abaixo e reporte:\n\n" .. tostring(errorMessage))
end

-- Macro principal de seguir
followMacro = macro(200, "Follow", function()
  -- Bloco de execução segura (try-catch)
  local success, err = pcall(function()
    ----------------------------------------------------------------
    -- Início da Lógica Original do Macro
    ----------------------------------------------------------------
    if player:isWalking() then return end
    local leader = getCreatureByName(storage.followLeader)
    if not leader then return end

    local ppos = player:getPosition()
    local lpos = leader:getPosition()

    -- PRIORIDADE 1: USAR ESCADAS/BURACOS
    if stairToUse then
      if ppos:isEqual(stairToUse) then
        useGround(stairToUse)
        stairToUse = nil
        delay(500)
      else
        autoWalk(stairToUse, 10, {precision=0})
      end
      return
    end

    -- PRIORIDADE 2: SEGUIR NORMALMENTE
    if ppos.z == lpos.z then
      if ppos:distance(lpos) > 2 then
        autoWalk(lpos, 20, {ignoreNonPathable=false, precision=2, marginMin=1, marginMax=2})
        delay(100)
      end
    end
    ----------------------------------------------------------------
    -- Fim da Lógica Original do Macro
    ----------------------------------------------------------------
  end)

  -- Se a execução segura falhou (success == false), chama a função de erro
  if not success then
    handleError("Erro no Macro de Follow", err)
  end
end)

-- Gatilho que observa a mudança de posição
onCreaturePositionChange(function(creature, oldPos, newPos)
  -- Bloco de execução segura para o gatilho também
  local success, err = pcall(function()
    if creature:getName() == storage.followLeader then
      toFollowPos[newPos.z] = newPos
      if newPos.z ~= oldPos.z and oldPos.z == player:getPosition().z then
        stairToUse = oldPos
      end
    end
  end)

  -- Se falhar, também desativa o script e mostra o erro
  if not success then
    handleError("Erro no Evento de Posição", err)
  end
end)

-- Checkbox para ativar/desativar o macro
UI.Checkbox("Ativar Follow", function(widget, checked)
  if checked then
    followMacro:on()
  else
    followMacro:off()
  end
end)
-- Inicia o macro desativado por padrão
followMacro:off()

UI.Separator()